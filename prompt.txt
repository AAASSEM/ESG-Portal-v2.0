I'll help you switch from SendGrid to SMTP for email sending. Here's what you need to do:

## 1. Update your `.env` file

Replace your current email configuration with this SMTP setup:

```bash
DEBUG=True
SECRET_KEY=your-secret-key-change-this-12345678
ALLOWED_HOSTS=localhost,127.0.0.1

# Email Configuration - SMTP
USE_REAL_EMAIL=true
EMAIL_SERVICE=smtp
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=aaaibrahim.1104@gmail.com
EMAIL_HOST_PASSWORD=ekvt ejuq rfcb ztef
DEFAULT_FROM_EMAIL=aaaibrahim.1104@gmail.com

# Remove or comment out SendGrid config
# SENDGRID_API_KEY=...

FRONTEND_URL=http://localhost:3001
```

## 2. Update `email_service.py`

You need to modify the `send_email_verification` function to prioritize SMTP over SendGrid. Here's the key change:

# In send_email_verification function, replace the email sending logic (around line 180-220)

# Send email with better error handling
email_sent = False
email_error = None

# Use SMTP when EMAIL_SERVICE is set to 'smtp'
use_smtp = settings.EMAIL_SERVICE == 'smtp'

if use_smtp:
    # Use Django's SMTP email sending
    try:
        import time
        import sys
        start_time = time.time()
        print(f"üìß Attempting SMTP connection to {settings.EMAIL_HOST}...", file=sys.stderr)

        send_result = send_mail(
            subject=subject,
            message=plain_message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[recipient_email],
            html_message=html_message,
            fail_silently=False,
        )

        elapsed = time.time() - start_time
        print(f"‚úÖ Email sent in {elapsed:.2f} seconds", file=sys.stderr)

        # Check if email was actually sent
        if send_result == 1:
            email_sent = True
            print(f"‚úÖ Email sent successfully to {recipient_email}")
        else:
            email_sent = False
            email_error = f"SMTP returned {send_result} - email may not have been sent"
            print(f"‚ùå Email send failed (result={send_result})")

    except Exception as e:
        import traceback
        import sys
        email_sent = False
        email_error = f"{type(e).__name__}: {str(e)}"
        print(f"‚ùå Email failed: {type(e).__name__}: {str(e)}", file=sys.stderr)
        print(f"Full traceback:\n{traceback.format_exc()}", file=sys.stderr)
else:
    # Try SendGrid Web API (fallback for backward compatibility)
    use_web_api = (
        SENDGRID_API_AVAILABLE and
        getattr(settings, 'SENDGRID_API_KEY', None) and
        settings.EMAIL_SERVICE == 'sendgrid'
    )

    if use_web_api:
        print(f"üåê Using SendGrid Web API (bypassing SMTP)", file=sys.stderr)
        email_sent = send_email_via_sendgrid_api(
            to_email=recipient_email,
            subject=subject,
            html_content=html_message,
            plain_content=plain_message
        )
        if not email_sent:
            email_error = "SendGrid Web API failed"


## 3. Update `signals.py`

Similarly, update the signals to use SMTP instead of SendGrid:

# Update the send_email_after_token_creation function
# Replace all instances of:
# if settings.USE_REAL_EMAIL and SENDGRID_AVAILABLE:

# With:
# Use SMTP instead of SendGrid
if settings.EMAIL_SERVICE == 'smtp':
    # Use Django's SMTP email sending
    send_result = send_mail(
        subject=subject,
        message=plain_message,
        from_email=settings.DEFAULT_FROM_EMAIL,
        recipient_list=[instance.user.email],
        html_message=html_message,
        fail_silently=False,
    )
elif settings.USE_REAL_EMAIL and SENDGRID_AVAILABLE:
    # Fallback to SendGrid if configured
    try:
        sg = sendgrid.SendGridAPIClient(api_key=settings.SENDGRID_API_KEY)
        message = Mail(
            from_email=settings.DEFAULT_FROM_EMAIL,
            to_emails=instance.user.email,
            subject=subject,
            html_content=html_message,
            plain_text_content=plain_message
        )
        response = sg.send(message)
        print(f"‚úÖ SendGrid API response: {response.status_code}")
        send_result = 1 if response.status_code in [200, 201, 202] else 0
    except Exception as e:
        print(f"‚ùå SendGrid API error: {e}")
        send_result = 0
else:
    # Fallback to Django's send_mail for local development
    send_result = send_mail(
        subject=subject,
        message=plain_message,
        from_email=settings.DEFAULT_FROM_EMAIL,
        recipient_list=[instance.user.email],
        html_message=html_message,
        fail_silently=False,
    )


## 4. Update Django Settings

Make sure your Django `settings.py` file has these email configurations:

```python
# Email Configuration
USE_REAL_EMAIL = os.environ.get('USE_REAL_EMAIL', 'false').lower() == 'true'
EMAIL_SERVICE = os.environ.get('EMAIL_SERVICE', 'smtp')

if EMAIL_SERVICE == 'smtp':
    EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
    EMAIL_HOST = os.environ.get('EMAIL_HOST', 'smtp.gmail.com')
    EMAIL_PORT = int(os.environ.get('EMAIL_PORT', 587))
    EMAIL_USE_TLS = os.environ.get('EMAIL_USE_TLS', 'True').lower() == 'true'
    EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER', '')
    EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD', '')
else:
    # Console backend for development
    EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'

DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL', 'noreply@esgportal.com')
EMAIL_SUBJECT_PREFIX = '[ESG Portal] '
```





so its work in the local but not in the production . are those Environment Variables correct . and i get this in the console 'refresh.js:27 WebSocket connection to 'ws://localhost:8081/' failed:

main.4c90c69d.js:2 üîÑ Making request to: https://esg-portal.onrender.com/api/users/

main.4c90c69d.js:2 üîë CSRF token: obtained

main.4c90c69d.js:2  POST https://esg-portal.onrender.com/api/users/ 502 (Bad Gateway)

main.4c90c69d.js:2 ‚úÖ Request completed: https://esg-portal.onrender.com/api/users/ Status: 502

main.4c90c69d.js:2 Failed to create user: SyntaxError: Failed to execute 'json' on 'Response': Unexpected end of JSON input     at onSubmit (main.4c90c69d.js:2:487516)

Ôªø'

